# üîí ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢: ‡∏£‡∏±‡∏ô SQL ‡∏ã‡πâ‡∏≥

## ‚úÖ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ: **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢!** ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

---

## üõ°Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ 100% (‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°)

### 1. Tables
```sql
CREATE TABLE IF NOT EXISTS ...
```
- ‚úÖ **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢**: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
- ‚úÖ **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°**: ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢

### 2. Indexes
```sql
CREATE INDEX IF NOT EXISTS ...
```
- ‚úÖ **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢**: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ index ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
- ‚úÖ **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°**: ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢

### 3. Default Data (INSERT)
```sql
INSERT INTO hospitals (name) VALUES (...)
ON CONFLICT (name) DO NOTHING;
```
- ‚úÖ **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢**: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà insert ‡∏ã‡πâ‡∏≥
- ‚úÖ **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°**: ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢

### 4. Extensions
```sql
CREATE EXTENSION IF NOT EXISTS ...
```
- ‚úÖ **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢**: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ extension ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£

---

## ‚ö†Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏±‡∏ö (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤)

### 1. Policies
```sql
DROP POLICY IF EXISTS "..." ON table_name;
CREATE POLICY "..." ON table_name ...;
```
- ‚ö†Ô∏è **‡∏à‡∏∞‡∏ó‡∏±‡∏ö policy ‡πÄ‡∏î‡∏¥‡∏°**: ‡πÅ‡∏ï‡πà policy ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πá‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
- ‚úÖ **‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤**: ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ policy ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πá‡∏Ñ‡∏∑‡∏≠ "Allow all operations" ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

### 2. Functions
```sql
CREATE OR REPLACE FUNCTION ...
```
- ‚ö†Ô∏è **‡∏à‡∏∞‡∏ó‡∏±‡∏ö function ‡πÄ‡∏î‡∏¥‡∏°**: ‡πÅ‡∏ï‡πà function ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πá‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
- ‚úÖ **‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤**: ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ function ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πá‡∏Ñ‡∏∑‡∏≠ `update_updated_at_column()` ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

### 3. Triggers
```sql
CREATE TRIGGER ... -- ‡πÑ‡∏°‡πà‡∏°‡∏µ IF EXISTS
```
- ‚ö†Ô∏è **‡∏≠‡∏≤‡∏à error**: ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ trigger ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞ error
- ‚úÖ **‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**: Script ‡πÉ‡∏ä‡πâ `CREATE TRIGGER` ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ IF EXISTS)
- üí° **‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ**: ‡∏ñ‡πâ‡∏≤ error ‡πÉ‡∏´‡πâ‡∏•‡∏ö trigger ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ migration_safe.sql ‡πÅ‡∏ó‡∏ô

---

## üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏£‡∏≤‡∏á

| ‡∏™‡πà‡∏ß‡∏ô | ‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°? | ‡∏ó‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á? | ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢? |
|------|---------------|---------------|----------|
| CREATE TABLE IF NOT EXISTS | ‚ùå ‡πÑ‡∏°‡πà | ‚ùå ‡πÑ‡∏°‡πà | ‚úÖ 100% |
| CREATE INDEX IF NOT EXISTS | ‚ùå ‡πÑ‡∏°‡πà | ‚ùå ‡πÑ‡∏°‡πà | ‚úÖ 100% |
| INSERT ... ON CONFLICT DO NOTHING | ‚ùå ‡πÑ‡∏°‡πà | - | ‚úÖ 100% |
| DROP POLICY + CREATE POLICY | ‚ùå ‡πÑ‡∏°‡πà | ‚ö†Ô∏è ‡∏ó‡∏±‡∏ö policy | ‚úÖ 99% (policy ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô) |
| CREATE OR REPLACE FUNCTION | ‚ùå ‡πÑ‡∏°‡πà | ‚ö†Ô∏è ‡∏ó‡∏±‡∏ö function | ‚úÖ 99% (function ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô) |
| CREATE TRIGGER | ‚ùå ‡πÑ‡∏°‡πà | ‚ö†Ô∏è ‡∏≠‡∏≤‡∏à error | ‚ö†Ô∏è 80% (‡∏≠‡∏≤‡∏à error ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) |

---

## üéØ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥

### ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß:

#### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: Backup ‡∏Å‡πà‡∏≠‡∏ô (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
```sql
-- Backup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
SELECT * FROM patients;
SELECT * FROM test_results;
-- Export ‡πÄ‡∏õ‡πá‡∏ô CSV ‡∏´‡∏£‡∏∑‡∏≠ JSON
```

#### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡πÉ‡∏ä‡πâ Migration Script ‡πÅ‡∏ó‡∏ô
- ‡πÉ‡∏ä‡πâ `migration_safe.sql` ‡πÅ‡∏ó‡∏ô `schema_complete.sql`
- ‡∏à‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á

#### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏±‡∏á‡∏ß‡∏•)
- Script ‡πÉ‡∏ä‡πâ `IF NOT EXISTS` ‡πÅ‡∏•‡∏∞ `ON CONFLICT DO NOTHING`
- **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢** ‡πÅ‡∏ï‡πà policy/function ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö (‡πÅ‡∏ï‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)

---

## üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏±‡∏ô

### ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß:

```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public';

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
SELECT COUNT(*) FROM patients;
SELECT COUNT(*) FROM hospitals;
SELECT COUNT(*) FROM admins;

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö policies
SELECT tablename, policyname 
FROM pg_policies;
```

---

## ‚úÖ ‡∏™‡∏£‡∏∏‡∏õ

### **‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!** ‡πÅ‡∏ï‡πà:

1. ‚úÖ **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°**: ‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ `IF NOT EXISTS` ‡πÅ‡∏•‡∏∞ `ON CONFLICT DO NOTHING`)
2. ‚ö†Ô∏è **Policies/Functions**: ‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏ó‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
3. ‚ö†Ô∏è **Triggers**: ‡∏≠‡∏≤‡∏à error ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢ migration_safe.sql)

### ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
- **‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**: ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚úÖ
- **‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**: Backup ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ `migration_safe.sql` ‡πÅ‡∏ó‡∏ô

---

## üÜò ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î Error

### Error: trigger already exists
**‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç**: ‡∏•‡∏ö trigger ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
```sql
DROP TRIGGER IF EXISTS update_patients_updated_at ON patients;
-- ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏±‡∏ô schema ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
```

### Error: duplicate key
**‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤**: ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (ON CONFLICT DO NOTHING ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ)

### Error: relation already exists
**‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤**: ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (IF NOT EXISTS ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ)



